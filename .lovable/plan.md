

# Улучшение системного промпта для prompt-tester

## Что делаем

Два улучшения в edge-функции `prompt-tester`:

1. **Передача контекста задания в AI** -- чтобы модель понимала, к какому упражнению относится промпт (анализ документов, deep research, повестка встречи и т.д.) и давала релевантные рекомендации.

2. **Отсечение нерелевантных запросов через AI** -- если пользователь просит "расскажи сказку", "напиши пост в телеграм", "что такое квантовая физика" -- AI должен вежливо отказать и напомнить, что инструмент предназначен только для тренировки промптов по конкретному заданию.

## Технические изменения

### Файл: `supabase/functions/prompt-tester/index.ts`

**1. Добавить словарь описаний заданий**

Маппинг `taskContext` в человекочитаемое описание задания на русском:

| taskContext | Описание |
|---|---|
| document-analysis | Анализ документов: составление executive summary, выделение ключевых тезисов |
| deep-research | Глубокое исследование: формулировка исследовательских вопросов, поиск данных |
| specialized-gpt | Создание специализированного GPT-ассистента: написание системной инструкции |
| client-response | Ответ клиенту: составление профессионального письма |
| meeting-agenda | Повестка встречи: подготовка аджены и follow-up письма |
| feedback-colleagues | Обратная связь коллегам: конструктивный фидбек |

**2. Обновить системный промпт для AI**

Системный промпт будет включать:
- Роль: эксперт по оценке промптов
- Контекст текущего задания (из словаря выше)
- Четкое указание: оценивать ТОЛЬКО промпты, связанные с упражнением
- Инструкцию отклонять нерелевантные запросы (сказки, посты, вопросы не по теме) с вежливым объяснением
- Запрет на выполнение самого задания -- только оценка структуры и рекомендации
- Ограничение ответа до 300 слов

**3. Заменить `evaluatePromptStructure()` на `evaluateWithAI()`**

Новая async-функция:
- Вызывает Lovable AI Gateway (`google/gemini-3-flash-preview`) через `LOVABLE_API_KEY`
- Передает системный промпт с контекстом задания + промпт пользователя
- Обрабатывает ошибки 429 (rate limit) и 402 (credits) с понятными сообщениями
- Fallback на простой текстовый ответ если AI недоступен

**4. Смягчить клиентскую валидацию `validatePrompt()`**

Убрать жесткую проверку по ключевым словам (блок `taskKeywords`), т.к. теперь AI сам определяет релевантность промпта. Оставить только:
- Проверку на пустоту
- Проверку длины (2000 символов)
- Anti-cheating паттерны (SQL-инъекции, обход системного промпта)

### Без изменений на фронтенде
Компонент `PromptTester.tsx` уже корректно отправляет `taskContext` и отображает ответ.

### Секреты
Будет использоваться `LOVABLE_API_KEY` (уже доступен автоматически). Проверим наличие и добавим если нужно.

## Итого: 1 файл, деплой edge-функции


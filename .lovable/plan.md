
# Переделка логики двух окон: Тестирование промпта и Сдача задания

## Концепция

Меняем назначение двух ключевых блоков на всех страницах заданий:

| Блок | Было | Станет |
|---|---|---|
| **Тестирование промпта** | AI оценивает структуру промпта | AI выполняет промпт как обычная нейросеть (песочница) |
| **Сдача задания** | Пользователь отправляет ответ, тьютор дает фидбек | Тьютор оценивает промпт по методу Сократа, помогает улучшить |
| **Засчитать задание** | Нет (задание автоматически считалось сданным) | Кнопка "Засчитать задание" -- пользователь решает сам |

## Технические изменения

### 1. Backend: `supabase/functions/prompt-tester/index.ts`

Полностью переделать системный промпт в `evaluateWithAI()`:

- **Было:** "Ты эксперт по оценке промптов... оценивай структуру..."
- **Станет:** "Ты -- AI-ассистент. Выполни задание пользователя в рамках указанного контекста."

Новая логика:
- AI получает контекст задания из `TASK_DESCRIPTIONS` и выполняет промпт как обычный ChatGPT
- Единственное ограничение: если запрос не по теме задания, вежливо отказать
- Убрать запрет на выполнение задания -- теперь AI именно выполняет промпт
- Увеличить лимит ответа (убрать ограничение в 300 слов)

### 2. Backend: `supabase/functions/chat-assistant/index.ts`

Обновить системный промпт тьютора (через `ALLOWED_TASK_CONTEXTS` и enhanced message):

- Добавить инструкцию: оценивать промпт пользователя по методу Сократа
- Задавать наводящие вопросы ("Как думаешь, что было бы, если добавить...?")
- Не давать готовый промпт, а направлять к улучшению
- Указывать на конкретные слабые места промпта

Для этого нужно будет создать новую edge-функцию `tutor-chat` (или добавить режим в существующую `chat-assistant`), т.к. сейчас `chat-assistant` использует OpenAI Assistants API с конкретным assistant_id. Оптимальнее добавить параметр `mode` в `chat-assistant` и использовать Lovable AI Gateway для режима тьютора вместо OpenAI Assistants.

### 3. Компонент: `src/components/BlurredAnswerBlock.tsx`

Переделать компонент:
- Убрать блюр-эффект (больше не нужен, т.к. это теперь чат с тьютором с самого начала)
- Превратить в полноценный чат-интерфейс с тьютором (аналогично текущему `isChatMode`)
- Пользователь вводит промпт, тьютор оценивает и задает вопросы по Сократу
- Добавить кнопку "Засчитать задание" внизу чата

### 4. Новый компонент: кнопка "Засчитать задание"

Добавить в блок тьютора (после чата):
- Кнопка "Засчитать задание" (зеленая, с иконкой CheckCircle)
- По нажатию: сохранить в БД через `submitAssignment` + `updateSubmissionStatus` со статусом `completed`
- Показать подтверждение (toast) и поменять состояние кнопки на "Задание засчитано"

### 5. Все 5 страниц заданий

Обновить логику на каждой странице:
- `TaskClientResponse.tsx`
- `TaskFeedback.tsx`
- `TaskMeetingAgenda.tsx`
- `TaskDocumentAnalysis.tsx`
- `TaskDeepResearch.tsx`

Изменения на каждой:
- Убрать `isChatMode` -- чат с тьютором доступен сразу (внутри блока "Сдать задание")
- `BlurredAnswerBlock` заменить на новый компонент `TutorChat`
- Добавить кнопку "Засчитать задание"
- `handleSubmitTask` больше не переключает режим, а просто отправляет первое сообщение тьютору
- Также добавить `TaskSpecializedGPT.tsx` если он использует ту же структуру

### 6. Фронтенд: обновить `PromptTester.tsx`

Минимальные изменения:
- Обновить текст подсказки: "Здесь вы можете протестировать ваш промпт и увидеть ответ нейросети"
- Убрать текст про "проверку структуры"
- Заменить заголовок информационного попапа

## Новый компонент: `TutorChat`

Создать `src/components/TutorChat.tsx`:
- Чат-интерфейс с тьютором (список сообщений + поле ввода)
- Блюр-эффект до первого взаимодействия (как было в BlurredAnswerBlock)
- Кнопка "Засчитать задание" внизу
- Props: `taskContext`, `onComplete`, `assignmentId`, `userId`
- Использует Lovable AI Gateway через `chat-assistant` (или новую edge-функцию)

## Поток пользователя

```text
1. Читает задание
2. Пишет промпт в "Тестирование промпта" --> получает ответ нейросети
3. Итерирует промпт в песочнице до удовлетворяющего результата
4. Нажимает "Сдать задание" (блюр-кнопка) --> открывается чат с тьютором
5. Вставляет промпт --> тьютор оценивает по Сократу, задает вопросы
6. Диалог с тьютором для улучшения промпта
7. Когда доволен результатом --> нажимает "Засчитать задание"
```

## Итого файлов

- `supabase/functions/prompt-tester/index.ts` -- новый системный промпт (песочница)
- `supabase/functions/chat-assistant/index.ts` -- добавить режим тьютора через Lovable AI
- `src/components/TutorChat.tsx` -- новый компонент
- `src/components/BlurredAnswerBlock.tsx` -- упростить или удалить
- `src/components/PromptTester.tsx` -- обновить тексты
- 5 страниц заданий -- подключить TutorChat + кнопку "Засчитать задание"
